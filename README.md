# hullqinCommunicationSystem

暂定接口文档



------

## 总述

该聊天系统提供基于 HTTP 和 WebSocket 的实时通讯能力，支持以下核心功能：

- **加入房间**：用户提交房间号与用户名，即可获取用于 WebSocket 连接的唯一地址。
- **实时聊天**：用户利用 WebSocket 连接发送消息，系统对消息进行存储、广播，同时写入每日日志。
- **获取历史消息**：查询当前房间内存中存储的所有聊天记录。
- **主动注销**：用户主动退出时，通过注销接口将自己标记为主动退出（同时服务器主动断开 WebSocket 连接），仅当房间内所有用户均主动退出后，才对房间数据进行归档清理。

------

## 1. 加入房间接口

### 接口描述

- **URL**：`POST /api/getws`
- **提交方式**：JSON 格式，通过 HTTP POST 提交
- **用途**：用户请求加入指定房间，服务器为请求生成唯一的 UUID 并返回对应的 WebSocket 连接地址，用于后续实时通讯。

### 请求示例

```json
POST /api/getws
Content-Type: application/json

{
  "roomid": "room1",
  "username": "alice"
}
```

### 响应示例

```json
{
  "ws_url": "/ws/550e8400-e29b-41d4-a716-446655440000"
}
```

### 参数说明

| 参数     | 类型   | 必填 | 说明                   |
| -------- | ------ | ---- | ---------------------- |
| roomid   | string | Yes  | 聊天房间编号，用户指定 |
| username | string | Yes  | 用户名                 |

------

## 2. WebSocket 聊天通信

### 接口描述

- **URL**：`WS /ws/{uuid}`
- **提交方式**：WebSocket 协议
- **用途**：建立长连接后，用户通过该连接实时发送和接收聊天消息。

### 建立连接

客户端需使用上一步返回的 `ws_url` 建立 WebSocket 连接，例如：

```
ws://<服务器地址>:8080/ws/550e8400-e29b-41d4-a716-446655440000
```

### 消息发送格式

客户端发送消息应使用 JSON 格式，目前支持的消息类型为 `"message"`：

```json
{
  "type": "message",
  "content": "你好，大家好!"
}
```

### 消息接收

以下说明描述了当 WebSocket 收到一条聊天消息后，服务器如何处理并广播消息给所有连接用户，包括发送消息的用户自身。具体格式和行为如下：

---

### 消息广播格式

当服务器接收到一条消息（格式应类似于下面的 JSON 数据）：
```json
{
  "type": "message",
  "content": "你好，大家好!"
}
```
服务器内部会构造一个完整的聊天消息对象（ChatMessage），其 JSON 格式如下：
```json
{
  "type": "message",
  "sender": "alice",
  "content": "你好，大家好!",
  "timestamp": "2023-10-16T12:34:56Z"
}
```

- **字段说明：**
  - **type**：固定为 `"message"`，用于标识消息类型。
  - **sender**：消息发送者的用户名（如 `alice`）。
  - **content**：聊天消息的具体内容。
  - **timestamp**：消息生成时的时间戳，通常为 ISO8601 格式（UTC时间）。

---

### 推送行为说明

- **广播所有用户**  
  服务器在接收到消息后，会将该消息对象广播给当前房间内的所有在线用户，包括发送消息的用户本身。这意味着即使是自己发送的消息，在通过 WebSocket 进行广播时也会收到一份拷贝。

- **用于客户端处理**  
  前端或客户端在接收到消息推送时，可以通过该完整的消息格式进行展示或其他业务逻辑处理，确保消息顺序一致并显示“自己发送”的消息。

---

### 小结

- 当用户通过 WebSocket 连接发送聊天消息时，服务器解析并封装成带有发送者与时间戳的消息对象，然后通过广播机制发送给房间内所有在线用户（包括发送方）。
- 因此，前端接收推送时会收到所有消息的完整数据结构，而这其中也包含了用户自己发送的消息（只会推送一次）。

这样设计确保每个用户都能从统一的消息流中获取完整信息，便于后续的显示和交互。

------

## 3. 获取历史消息接口

### 接口描述

- **URL**：`GET /api/history?roomid={roomid}`
- **提交方式**：HTTP GET，通过 URL 查询参数提交
- **用途**：获取指定房间当前内存中存储的所有聊天记录（未归档数据）。

### 请求示例

```
GET /api/history?roomid=room1
```

### 响应示例

```json
[
  {
    "type": "message",
    "sender": "alice",
    "content": "你好，大家好!",
    "timestamp": "2023-10-16T12:34:56Z"
  },
  {
    "type": "message",
    "sender": "bob",
    "content": "Hi, Alice!",
    "timestamp": "2023-10-16T12:35:10Z"
  }
]
```

### 参数说明

| 参数   | 类型   | 必填 | 说明                 |
| ------ | ------ | ---- | -------------------- |
| roomid | string | Yes  | 查询记录对应的房间号 |

------

## 4. 注销用户接口

### 接口描述

- **URL**：`POST /api/logout`
- **提交方式**：JSON 格式，通过 HTTP POST 提交
- **用途**：用户主动注销时调用，服务器将：
  1. 将该用户标记为“主动注销”，使 UUID 立即失效；
  2. 主动向该用户的 WebSocket 发送关闭帧，断开连接；
  3. 移除该用户记录；
      当房间内所有用户均为主动注销状态时，系统归档房间聊天记录并清除该房间内存数据。

### 请求示例

```json
POST /api/logout
Content-Type: application/json

{
  "roomid": "room1",
  "username": "alice",
  "uuid": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 响应示例

```plain
注销成功
```

### 参数说明

| 参数     | 类型   | 必填 | 说明                            |
| -------- | ------ | ---- | ------------------------------- |
| roomid   | string | Yes  | 房间编号                        |
| username | string | Yes  | 用户名，用于校验                |
| uuid     | string | Yes  | 用户通过加入房间接口获取的 UUID |

------

## 5. 数据持久化与日志记录

虽然不直接作为 API 接口暴露，但系统内部实现了以下数据持久化机制，供系统管理员及后续扩展参考：

- **聊天记录归档**：
   当房间内所有用户均主动注销后，系统会将该房间所有聊天记录以 JSON 格式写入宿主机挂载的 `data` 目录中，文件名中包含归档时间，以便后续查询与数据备份。
- **聊天日志**：
   每一条聊天消息会根据发送日期记录到对应的日志文件中，日志按照日期分目录存放，例如 `logs/20231016/chat.log`。此机制有助于实时排查问题以及数据审计。

------

## 6. 注意事项

- **异常断开处理**
   若 WebSocket 在异常情况下断开（如错误码 1006），系统不会自动删除该用户记录，只有经过前端主动调用注销接口时，才视为用户正式退出，触发后续归档操作。
- **UUID 有效性**
   在调用注销接口后，服务器会立即使该 UUID 失效并断开 WebSocket 连接，以确保用户权限及时更新，防止会话滥用。
- **请求格式与状态码**
   每个接口应确保请求格式正确（Content-Type 为 `application/json` 对于 POST 接口），错误请求将返回相应的 HTTP 状态码，如 400（参数缺失或无效）等。

------

